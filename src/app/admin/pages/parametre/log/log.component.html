<ngx-loading [show]="loading" [config]="{ backdropBorderRadius: '5px',fullScreenBackdrop:true }"></ngx-loading>
<div class="row">
    <div class="col-12 mb-3">
        <div class="card border-0 shadow-sm rounded-4 logs-header-card">
            <div class="card-toolbar px-4 py-3 d-flex justify-content-between align-items-center">
                <!-- Titre + icône -->
                <div class="d-flex align-items-center">
                    <i class="mdi mdi-alarm-multiple fs-3 text-primary me-2"></i>
                    <h4 class="m-0 fw-bold title-logs">Logs</h4>
                </div>
                <!-- Breadcrumb -->
                <ul class="breadcrumb-custom m-0">
                    <li>
                        <a [routerLink]="['/admin/parametre']" class="breadcrumb-link">
                            Administration
                        </a>
                    </li>
                    <li class="separator">/</li>
                    <li class="active">Logs</li>
                </ul>
            </div>
        </div>
    </div>


    <div class="col-sm-12 col-md-12 col-lg-12">
        <div class="card">
            <div class="card-body shadow-reset">
                <div class="card-header enhanced-toolbar">
                    <div class="row g-3 align-items-end">

                        <!-- Date début -->
                        <div class="col-lg-2 col-md-3 col-sm-6">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Date début</mat-label>
                                <input matInput [matDatepicker]="dateDebut" [(ngModel)]="searchParam.dateDebut"
                                    name="dateDebut" readonly>
                                <mat-datepicker-toggle matSuffix [for]="dateDebut"></mat-datepicker-toggle>
                                <mat-datepicker #dateDebut></mat-datepicker>
                            </mat-form-field>
                        </div>

                        <!-- Date fin -->
                        <div class="col-lg-2 col-md-3 col-sm-6">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Date fin</mat-label>
                                <input matInput [matDatepicker]="dateFin" [(ngModel)]="searchParam.dateFin"
                                    name="dateFin" readonly>
                                <mat-datepicker-toggle matSuffix [for]="dateFin"></mat-datepicker-toggle>
                                <mat-datepicker #dateFin></mat-datepicker>
                            </mat-form-field>
                        </div>

                        <!-- Critère -->
                        <div class="col-lg-2 col-md-3 col-sm-6">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Recherche par</mat-label>
                                <mat-select name="criteria" [(ngModel)]="searchParam.criteria"
                                    (selectionChange)="onChangeCritere()">
                                    <mat-option value="1">Tous</mat-option>
                                    <mat-option value="2">Action</mat-option>
                                    <mat-option value="3">Utilisateur</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>

                        <!-- Recherche Action -->
                        <div class="col-lg-2 col-md-3 col-sm-6" *ngIf="searchParam.criteria === '2'">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Entrer une action</mat-label>
                                <input matInput [(ngModel)]="searchParam.query" name="searchTerm">
                            </mat-form-field>
                        </div>

                        <!-- Sélection utilisateur -->
                        <div class="col-lg-3 col-md-4 col-sm-12" *ngIf="searchParam.criteria === '3'">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Utilisateur</mat-label>
                                <mat-select [(ngModel)]="searchParam.id" name="utilisateur">

                                    <!-- Champ recherche interne -->
                                    <div class="select-search-box">
                                        <input matInput autocomplete="off" [(ngModel)]="utilisateurFilter.nomComplet"
                                            placeholder="Rechercher...">
                                        <i class="mdi mdi-magnify search-icon"></i>
                                    </div>

                                    <mat-divider></mat-divider>

                                    <mat-option [value]="">Désélectionner</mat-option>

                                    <!-- Liste utilisateurs -->
                                    <mat-option *ngFor="let utilisateur of utilisateurs | filterBy: utilisateurFilter"
                                        [value]="utilisateur.id">
                                        {{ utilisateur.nomComplet }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>

                        <!-- Bouton recherche -->
                        <div class="col-lg-1 col-md-2 col-sm-4">
                            <button type="button" class="btn btn-refresh" title="Actualiser" (click)="search()">
                                <i class="mdi mdi-cached"></i>
                            </button>
                        </div>

                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="table-wrapper shadow-sm rounded-4 big-table-container">
                            <table mat-table matTableExporter [dataSource]="dataSource" #exporter matSort
                                class="mat-elevation-z1 custom-mat-table big-table">

                                <!-- DATE -->
                                <ng-container matColumnDef="dateLog">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
                                    <td mat-cell *matCellDef="let row">
                                        <i class="mdi mdi-calendar-clock me-1 text-muted"></i>
                                        {{ row.created_at | date: 'dd/MM/yyyy HH:mm:ss' }}
                                    </td>
                                </ng-container>

                                <!-- UTILISATEUR -->
                                <ng-container matColumnDef="agent">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Utilisateur</th>
                                    <td mat-cell *matCellDef="let row">
                                        <div class="user-cell">
                                            <i class="mdi mdi-account-circle user-icon"></i>
                                            {{ row.user?.nomComplet }}
                                        </div>
                                    </td>
                                </ng-container>

                                <!-- ACTION -->
                                <ng-container matColumnDef="action">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Action</th>
                                    <td mat-cell *matCellDef="let row">{{ row.action }}</td>
                                </ng-container>

                                <!-- DESCRIPTION -->
                                <ng-container matColumnDef="description">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Description</th>
                                    <td mat-cell *matCellDef="let row">{{ row.description }}</td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="row-hover"></tr>

                            </table>
                        </div>

                        <!-- Aucun résultat -->
                        <div *ngIf="logs?.length === 0" class="empty-state">
                            <img src="assets/images/no_empty.png" alt="" class="empty-img">
                            <h4>Aucun résultat trouvé</h4>
                        </div>

                        <!-- Pagination -->
                        <mat-paginator [pageSize]="10" [pageSizeOptions]="[5,10,20,30,50,100]" class="mt-3">
                        </mat-paginator>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>